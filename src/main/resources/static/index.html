<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智商大作战</title>
    <script src="./js/uuid.min.js"></script>
    <script src="./util/utils.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/mystyle.css" rel="stylesheet">
    <script src="./js/jquery-3.1.1.min.js"></script>
    <script src="./js/bootstrap3.0.3.min.js"></script>
    <script src="./js/html2canvas.min.js"></script>
</head>
<body>
<div id="roomPage" class="page active">
    <div class="game-container">
        <h1>智商大作战</h1>
        <div class="game-tip">输入相同房间号即可联机对战</div>
        <div class="input-container">
            <input type="number" id="roomCodeInput" placeholder="请输入房间号" autofocus>
            <button id="joinBtn">进入游戏</button>
        </div>
        <div id="loadingMessage" style="display: none; color: #333; font-size: 18px; margin-top: 20px;">
            正在进入房间...
        </div>
    </div>
    <div class="room-full-tip" id="roomFullTip">
        房间已满
    </div>
</div>

<div id="gamePage" class="page">
    <div class="home-icon" onclick="goHome()">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/>
        </svg>
    </div>
    <div class="share-icon" onclick="shareGame()">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z" fill="currentColor"/>
        </svg>
    </div>
    <div class="container-fluid">
        <div class="row clearfix" style="text-align: center">
            <div id="opponentSide" style="display: none;">
                <div class="col-md-24 column">
                    <br>
                    <div class="player-name" style="color: red" id="opponentName"></div>
                    <div id="opponentWinRate"></div>
                    <br>
                    <div class="card-side">
                        <button id="opp1" type="button" class="btn btn-default opponent-card">1</button>
                        <button id="opp2" type="button" class="btn btn-default opponent-card">2</button>
                        <button id="opp3" type="button" class="btn btn-default opponent-card">3</button>
                        <button id="opp4" type="button" class="btn btn-default opponent-card">4</button>
                        <button id="opp5" type="button" class="btn btn-default opponent-card">5</button>
                    </div>
                </div>
                <br>
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="opp6" type="button" class="btn btn-default  opponent-card">6</button>
                        <button id="opp7" type="button" class="btn btn-default opponent-card">7</button>
                        <button id="opp8" type="button" class="btn btn-default opponent-card">8</button>
                        <button id="opp9" type="button" class="btn btn-default opponent-card">9</button>
                        <button id="opp10" type="button" class="btn btn-default opponent-card">10</button>
                    </div>
                </div>
            </div>

            <div id="centerSide">
                <br>
                <br>
                <div id="waitAnotherPlayer" style="display: none;">
                    <button type="button" class="btn btn-primary">等待对手进入...</button>
                </div>
                <div id="rematchRequest" style="display: none;">
                    <p style="margin-bottom: 15px;color:#4CAF50FF;">对手请求继续游戏</p>
                    <div class="button-group">
                        <button onclick="rejectRematch()" class="btn-secondary-action">拒绝</button>
                        <button onclick="acceptRematch()" class="btn-primary-action">接受</button>
                    </div>
                </div>
                <div id="point" style="display: none;">
                    <label style="color:#4CAF50FF;">对方已落定</label>
                </div>
                <br>
                <br>
            </div>

            <div id="mySide" style="display: none;">
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="my1" type="button" class="btn btn-default" onclick="sendCard(1)">1</button>
                        <button id="my2" type="button" class="btn btn-default" onclick="sendCard(2)">2</button>
                        <button id="my3" type="button" class="btn btn-default" onclick="sendCard(3)">3</button>
                        <button id="my4" type="button" class="btn btn-default" onclick="sendCard(4)">4</button>
                        <button id="my5" type="button" class="btn btn-default" onclick="sendCard(5)">5</button>
                    </div>
                </div>
                <br>
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="my6" type="button" class="btn btn-default" onclick="sendCard(6)">6</button>
                        <button id="my7" type="button" class="btn btn-default" onclick="sendCard(7)">7</button>
                        <button id="my8" type="button" class="btn btn-default" onclick="sendCard(8)">8</button>
                        <button id="my9" type="button" class="btn btn-default" onclick="sendCard(9)">9</button>
                        <button id="my10" type="button" class="btn btn-default" onclick="sendCard(10)">10</button>
                    </div>
                </div>
                <br>
                <div class="player-name" id="myName">我</div>
                <div id="myWinRate"></div>
            </div>
        </div>
    </div>
</div>

<audio id="footstepSound" preload="auto">
    <source src="audio/footstep.mp3" type="audio/mpeg">
</audio>
<audio id="sendCardSound" preload="auto">
    <source src="audio/sendCard.mp3" type="audio/mpeg">
</audio>
<audio id="startSound" preload="auto">
    <source src="audio/start.mp3" type="audio/mpeg">
</audio>
<audio id="clickSound" preload="auto">
    <source src="audio/click.mp3" type="audio/mpeg">
</audio>
<audio id="victorySound" preload="auto">
    <source src="audio/victory.mp3" type="audio/mpeg">
</audio>
<audio id="defeatSound" preload="auto">
    <source src="audio/defeat.mp3" type="audio/mpeg">
</audio>

<script>
    let matchSocket = null;
    const deviceId = localStorage.getItem("deviceId") || generateDeviceId();

    function showPage(pageId) {
        $('.page').removeClass('active');
        $(`#${pageId}`).addClass('active');
    }

    function initWebSocket() {
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            matchSocket = new WebSocket(`${protocol}//${host}/match?deviceId=${deviceId}`);

            console.log('Attempting to connect to match WebSocket...');

            matchSocket.onopen = () => {
                console.log('Match WebSocket connected successfully');
            };

            matchSocket.onerror = (error) => {
                console.error('Match WebSocket error:', error);
                alert('连接服务器失败，请刷新页面重试');
                goHome();
            };

            matchSocket.onclose = () => {
                console.log('Match WebSocket connection closed');
                alert('玩家离开了房间');
                goHome();
            };

            matchSocket.onmessage = (event) => {
                handleMessage(event);
            };
        } catch (error) {
            console.error('Error creating match WebSocket:', error);
        }
    }

    function handleMessage(event) {
        console.log('Message received:', event.data);
        try {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'room_state':
                    showPage('gamePage');
                    const players = data.players;
                    const myData = players.find(user => user.deviceId === deviceId);
                    const opponentData = players.find(user => user.deviceId !== deviceId);

                    window.playerRole = myData.role;

                    if (myData) {
                        $('#mySide').show();
                        $('#myName').text('我：' + myData.nickName);
                        $('#myWinRate').text('胜率: ' + myData.winRate + '%');

                        if (myData.role === 'blueSide' && players.length === 1) {
                            $('#waitAnotherPlayer').show();
                            $('#waitAnotherPlayer button').text('等待对手进入....');
                            disableAllCards();
                        }
                    }

                    if (players.length === 2 && opponentData) {
                        $('#opponentSide').show();
                        $('#opponentName').text('对手：' + opponentData.nickName);
                        $('#opponentWinRate').text('胜率: ' + opponentData.winRate + '%');
                    }
                    break;

                case 'room_full':
                    $('#loadingMessage').hide();
                    $('#joinBtn').prop('disabled', false);
                    $('#roomCodeInput').prop('disabled', false);
                    $('#roomFullTip').addClass('show');
                    setTimeout(() => {
                        $('#roomFullTip').removeClass('show');
                    }, 3000);
                    break;

                case 'game_ready':
                    console.log('收到game_ready消息，游戏准备开始');
                    showPage('gamePage');
                    
                    const readyPlayers = data.players;
                    if (readyPlayers && readyPlayers.length === 2) {
                        const myPlayerData = readyPlayers.find(user => user.deviceId === deviceId);
                        const opponentPlayerData = readyPlayers.find(user => user.deviceId !== deviceId);

                        if (myPlayerData) {
                            window.playerRole = myPlayerData.role;
                            $('#mySide').show();
                            $('#myName').text('我：' + myPlayerData.nickName);
                            $('#myWinRate').text('胜率: ' + myPlayerData.winRate + '%');
                        }

                        if (opponentPlayerData) {
                            $('#opponentSide').show();
                            $('#opponentName').text('对手：' + opponentPlayerData.nickName);
                            $('#opponentWinRate').text('胜率: ' + opponentPlayerData.winRate + '%');
                        }
                    }
                    
                    $('#waitAnotherPlayer').hide();
                    showGameStart();
                    resetGameState4Begin();
                    break;

                case 'game_start':
                    $('#waitAnotherPlayer').hide();
                    showGameStart();
                    resetGameState4Begin();
                    break;

                case 'round_complete':
                    const myCard = data.myCard;
                    const oppCard = data.oppCard;
                    $(`#opp${oppCard}`).addClass('flip');
                    playCardSound();
                    enableRemainingCards();
                    break;

                case 'please_take_card':
                    $('#point').show();
                    playFootstepSound();
                    enableRemainingCards();
                    break;

                case 'game_result':
                    setTimeout(() => {
                        switch (data.result) {
                            case 'red_win':
                                showGameResult(window.playerRole === 'redSide');
                                break;
                            case 'blue_win':
                                showGameResult(window.playerRole === 'blueSide');
                                break;
                            case 'draw':
                                showGameResult(null);
                                break;
                        }
                    }, 1500);
                    break;

                case 'rematch_request':
                    $('#resultOverlay').removeClass('visible');
                    $('#rematchRequest').show();
                    $('.game-options').remove();
                    break;

                case 'rematch_accept':
                    // ✅ 注意：后端现在在handleRematchAccept中发送game_ready消息
                    // 这里保持兼容性，处理可能的rematch_accept消息
                    $('#point').hide();
                    $('#waitAnotherPlayer').hide();
                    $('.game-options').remove();
                    $('#opponentSide').show();
                    enableAllCards();
                    const startOverlay = document.getElementById('startOverlay');
                    startOverlay.classList.add('show');
                    playStartSound();
                    setTimeout(() => {
                        startOverlay.classList.remove('show');
                    }, 2000);
                    break;

                case 'opponent_leave':
                    alert(data.message);
                    goHome();
                    break;

                case 'share':
                    window.hasShareNotice = true;
                    window.shareTitle = data.title;
                    window.winnerName = data.winnerName;
                    window.loserName = data.loserName;
                    break;

                default:
                    console.warn('Unknown message type:', data.type);
            }
        } catch (error) {
            console.error('Error handling message:', error);
        }
    }

    function showGameStart() {
        $('#startOverlay').addClass('show');
        playStartSound();
        setTimeout(() => {
            $('#startOverlay').removeClass('show');
        }, 2000);
    }

    function showGameResult(isWinner) {
        const modal = document.getElementById('resultOverlay');
        const resultText = document.getElementById('resultText');

        if (isWinner === null) {
            resultText.textContent = '双赢';
        } else {
            resultText.textContent = isWinner ? '胜利' : '失败';
            if (isWinner) {
                playVictorySound();
            } else {
                playDefeatSound();
            }
            disableAllCards();
            $('#mySide').addClass('game-completed');
        }

        $('.home-icon').show();

        function showGameOptions(isWinner) {
            const gameOptions = `
                    <div class="game-options">
                        <div class="button-group">
                            <button onclick="leaveRoomToHome()" class="btn btn-secondary-action">主页</button>
                            <button onclick="requestRematch()" class="btn-primary-action">
                                ${isWinner ? '继续游戏' : '不服再战'}
                            </button>
                        </div>
                    </div>
                `;
            $('#centerSide').append(gameOptions);
        }

        showGameOptions(isWinner);
        modal.classList.add('visible');
    }

    function closeResult() {
        const modal = document.getElementById('resultOverlay');
        modal.classList.remove('visible');
        if (window.hasShareNotice) {
            $('.share-icon').addClass('visible')
                .data('shareTitle', window.shareTitle)
                .data('winnerName', window.winnerName)
                .data('loserName', window.loserName);
            setTimeout(() => {
                const shareNotice = `
                        <div class="share-notice">
                            <p>${window.shareTitle}</p>
                            <p>点击左上角保存战绩截图</p>
                        </div>
                    `;
                $('.share-notice').remove();
                const $notice = $(shareNotice).appendTo('#centerSide');
                setTimeout(() => {
                    $notice.fadeOut(500, function() {
                        $(this).remove();
                    });
                }, 5000);

                window.hasShareNotice = false;
                window.shareTitle = null;
                window.winnerName = null;
                window.loserName = null;
            }, 200);
        }
    }

    function playVictorySound() {
        const sound = document.getElementById('victorySound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function playDefeatSound() {
        const sound = document.getElementById('defeatSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function playStartSound() {
        const sound = document.getElementById('startSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function playCardSound() {
        const sound = document.getElementById('sendCardSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function playFootstepSound() {
        const sound = document.getElementById('footstepSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function initializeGamePage() {
        $('#opponentSide').hide();
        $('#mySide').hide();
        $('#waitAnotherPlayer').hide();
        $('#answer').hide();
        $('#rematchRequest').hide();
        $('#point').hide();
        $('#resultOverlay').removeClass('show');
        $('.home-icon').hide();
        $('.card-side button').removeClass('flip');
        $('.card-side button').prop('disabled', false);
    }

    $(document).ready(function() {
        initializeGamePage();
        initWebSocket();

        function toggleTip() {
            const tip = $('.game-tip');
            tip.addClass('show');
            setTimeout(() => {
                tip.removeClass('show');
            }, 7000);
        }

        setTimeout(() => {
            toggleTip();
            setInterval(toggleTip, 10000);
        }, 2000);

        $('#roomCodeInput').keypress(function(e) {
            if (e.which === 13) {
                $('#joinBtn').click();
            }
        });

        $('#joinBtn').click(function() {
            let roomCode = $('#roomCodeInput').val().trim();
            if (!roomCode) {
                alert("请输入房间号！");
                return;
            }

            if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
                console.error('WebSocket not connected. State:', matchSocket ? matchSocket.readyState : 'null');
                alert("正在连接服务器，请稍后重试...");
                initWebSocket();
                return;
            }

            console.log('Sending join request for room:', roomCode);

            let playerData = {
                type: "join_room",
                deviceId: deviceId,
                roomCode: roomCode,
                nickName: getNickname()
            };

            try {
                matchSocket.send(JSON.stringify(playerData));
                console.log('Join request sent successfully');
                playClickSound();
                $('#loadingMessage').show();
                $('#joinBtn').prop('disabled', true);
                $('#roomCodeInput').prop('disabled', true);
            } catch (error) {
                console.error('Error sending join request:', error);
                alert('发送请求失败，请重试');
                $('#loadingMessage').hide();
                $('#joinBtn').prop('disabled', false);
                $('#roomCodeInput').prop('disabled', false);
            }
        });
    });

    function playClickSound() {
        const sound = document.getElementById('clickSound');
        sound.volume = 0.7;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    function getNickname() {
        let nickname = localStorage.getItem("nickname");
        if (!nickname) {
            nickname = prompt("请输入您的昵称：");
            if (nickname && nickname.trim()) {
                localStorage.setItem("nickname", nickname);
            } else {
                nickname = "玩家";
            }
        }
        return nickname;
    }

    function sendCard(card) {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            console.error('Match WebSocket not connected');
            return;
        }

        try {
            playCardSound();
            $('.card-side button:not(.flip)').prop('disabled', true);
            $('#point').hide();
            $(`#my${card}`).addClass('flip');

            const message = {
                type: "play_card",
                deviceId: deviceId,
                card: card
            };
            matchSocket.send(JSON.stringify(message));
        } catch (error) {
            console.error('Error sending card:', error);
            enableRemainingCards();
        }
    }

    function disableAllCards() {
        for (let i = 1; i <= 10; i++) {
            $(`#my${i}`).prop('disabled', true).addClass('disabled');
        }
    }

    function enableRemainingCards() {
        for (let i = 1; i <= 10; i++) {
            const card = $(`#my${i}`);
            if (!card.hasClass('flip')) {
                card.prop('disabled', false);
            }
        }
    }

    function resetGameState4Begin() {
        $('#mySide .card-side button').removeClass('flip disabled');
        $('#mySide .card-side button').prop('disabled', false);
    }

    function resetGameState() {
        $('.card-side button').removeClass('flip disabled');
        $('#mySide').removeClass('game-completed');
        $('.card-side button').prop('disabled', false);
        $('#resultOverlay').removeClass('visible');
        $('#point').hide();
        $('.home-icon').hide();
    }

    function goHome() {
        showPage('roomPage');
        resetGameState();
        $('#opponentSide').hide();
        $('#mySide').hide();
        $('#waitAnotherPlayer').hide();
        $('.game-options').remove();
        $('#roomCodeInput').val('').prop('disabled', false);
        $('#joinBtn').prop('disabled', false);
        $('#loadingMessage').hide();

        if (matchSocket && matchSocket.readyState === WebSocket.OPEN) {
            const message = {
                type: "leave_room",
                deviceId: deviceId
            };
            matchSocket.send(JSON.stringify(message));
            matchSocket.close();
        }
    }

    function leaveRoomToHome() {
        goHome();
    }

    function requestRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("玩家离开了房间");
            goHome();
            return;
        }

        const message = {
            type: "rematch_request",
            deviceId: deviceId
        };
        matchSocket.send(JSON.stringify(message));

        resetGameState();
        disableAllCards();
        $('.game-options').remove();
        $('#waitAnotherPlayer').hide();
        $('#opponentSide').hide();
        $('#waitAnotherPlayer').show().find('button').text('等待对手响应...');
    }

    function shareGame() {
        const shareIcon = $('.share-icon');
        const title = shareIcon.data('shareTitle');
        const winnerName = shareIcon.data('winnerName');
        const loserName = shareIcon.data('loserName');

        const shareContent = document.createElement('div');
        shareContent.className = 'share-content';
        shareContent.innerHTML = `
                <div class="share-header">
                    <img src="image/game-icon.png" class="game-icon" alt="义父">
                    <span>十张牌</span>
                </div>
                <div class="share-main">
                    <div class="share-title">你未曾蒙面的义父</div>
                    <div class="share-image">
                        <img src="image/yifu.png" class="main-img" alt="义父">
                        <div class="winner-name">${winnerName}</div>
                        <div class="loser-name">${loserName}</div>
                        <div class="timestamp">${getCurrentTimestamp()}</div>
                    </div>
                </div>
                <div class="share-link">
                    <span>点击https://a985ced5c2a54919b9436aab65bd56b8--4396.ap-shanghai.cloudstudio.club/ 和你的好友对战吧！</span>
                </div>
            `;

        document.body.appendChild(shareContent);

        html2canvas(shareContent, {
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            try {
                const imgUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = '游戏战绩.png';
                link.href = imgUrl;
                link.click();
            } catch (error) {
                console.error('Error generating share image:', error);
                alert('生成分享图片失败，请重试');
            } finally {
                document.body.removeChild(shareContent);
            }
        }).catch(error => {
            console.error('Error with html2canvas:', error);
            alert('生成分享图片失败，请重试');
            document.body.removeChild(shareContent);
        });
    }

    function getCurrentTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}${month}${day} ${hours}:${minutes}`;
    }

    function acceptRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("玩家离开了房间");
            goHome();
            return;
        }

        const message = {
            type: "rematch_accept",
            deviceId: deviceId
        };
        matchSocket.send(JSON.stringify(message));
        $('#rematchRequest').hide();
        $('#waitAnotherPlayer').hide();
        resetGameState();
    }

    function rejectRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("玩家离开了房间");
            goHome();
            return;
        }

        const message = {
            type: "rematch_reject",
            deviceId: deviceId
        };
        matchSocket.send(JSON.stringify(message));
        $('#rematchRequest').hide();

        const gameOptions = `
                <div class="game-options">
                    <button onclick="goHome()" class="btn btn-primary">返回主页</button>
                </div>
            `;
        $('#centerSide').append(gameOptions);
    }

    function enableAllCards() {
        for (let i = 1; i <= 10; i++) {
            $(`#my${i}`).prop('disabled', false).removeClass('disabled');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem('deviceId')) {
            localStorage.setItem('deviceId', uuid.v4());
        }
    });
</script>

<div class="game-result-modal" id="resultOverlay">
    <div class="modal-content">
        <h2 id="resultText"></h2>
        <button onclick="closeResult()" class="confirm-btn">确认</button>
    </div>
</div>

<div class="start-overlay" id="startOverlay">
    <div class="start-text">游戏开始</div>
</div>
</body>
</html>