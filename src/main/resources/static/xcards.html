<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    <title>十張牌</title>
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/mystyle.css">
    <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
    <script src="./util/utils.js"></script>

</head>

<body>

<div class="container-fluid">
    <div class="row clearfix" style="text-align: center">
        <div id="opponentSide" aria-hidden="true" style="visibility: hidden;">
            <div class="col-md-24 column">
                <br>
                <div class="player-name" style="color: red" id="opponentName"></div><div id="opponentWinRate"></div>
                <br>
                <div class="card-side">
                    <button id="opp1" type="button" class="btn btn-default" disabled>1</button>
                    <button id="opp2" type="button" class="btn btn-default" disabled>2</button>
                    <button id="opp3" type="button" class="btn btn-default" disabled>3</button>
                    <button id="opp4" type="button" class="btn btn-default" disabled>4</button>
                    <button id="opp5" type="button" class="btn btn-default" disabled>5</button>
                </div>
            </div>
            <br>
            <div class="col-md-24 column">
                <div class="card-side">
                    <button id="opp6" type="button" class="btn btn-default" disabled>6</button>
                    <button id="opp7" type="button" class="btn btn-default" disabled>7</button>
                    <button id="opp8" type="button" class="btn btn-default" disabled>8</button>
                    <button id="opp9" type="button" class="btn btn-default" disabled>9</button>
                    <button id="opp10" type="button" class="btn btn-default" disabled>10</button>
                </div>
            </div>
        </div>

        <div id="centerSide">
            <br>
            <br>
            <div id="waitAnotherPlayer" aria-hidden="true" style="visibility: hidden;">
                <button onclick="location.reload()" type="button" class="btn btn-primary">等待对手进入...</button>
            </div>
            <div id="answer" aria-hidden="true" style="visibility: hidden;">
                <button onclick="location.reload()" type="button" class="btn btn-primary">再來一局</button>
            </div>
            <div id="point" aria-hidden="true" style="visibility: hidden;">
                <label>請出牌</label>
            </div>
            <br>
            <br>
        </div>

        <div id="mySide" aria-hidden="true" style="visibility: hidden;">
            <div class="col-md-24 column">
                <div class="card-side">
                    <button id="my1" type="button" class="btn btn-default" onclick="sendCard(1)">1</button>
                    <button id="my2" type="button" class="btn btn-default" onclick="sendCard(2)">2</button>
                    <button id="my3" type="button" class="btn btn-default" onclick="sendCard(3)">3</button>
                    <button id="my4" type="button" class="btn btn-default" onclick="sendCard(4)">4</button>
                    <button id="my5" type="button" class="btn btn-default" onclick="sendCard(5)">5</button>
                </div>
            </div>
            <br>
            <div class="col-md-24 column">
                <div class="card-side">
                    <button id="my6" type="button" class="btn btn-default" onclick="sendCard(6)">6</button>
                    <button id="my7" type="button" class="btn btn-default" onclick="sendCard(7)">7</button>
                    <button id="my8" type="button" class="btn btn-default" onclick="sendCard(8)">8</button>
                    <button id="my9" type="button" class="btn btn-default" onclick="sendCard(9)">9</button>
                    <button id="my10" type="button" class="btn btn-default" onclick="sendCard(10)">10</button>
                </div>
            </div>
            <br>
            <div class="player-name" id="myName">我</div><div id="myWinRate"></div>
        </div>

    </div>
</div>

<script>
    // 使用 let 和 const 代替 var，避免全局变量污染
    let websocket = null;
    let websocket4Room = null;
    let deviceId = localStorage.getItem("deviceId") || generateDeviceId(); // 获取生成的设备Id

    // 创建游戏 WebSocket连接
    websocket = new WebSocket(`ws://localhost:4396/game?deviceId=${deviceId}`);
    websocket.onopen = function (event) {
        console.log('websocket connection opened - websocket ');
    }
    // 创建房间控制 WebSocket连接
    websocket4Room = new WebSocket(`ws://localhost:4396/room?deviceId=${deviceId}`);
    websocket4Room.onopen = function() {
        console.log('websocket4Room connection opened - room');
    };

    websocket.onclose = function (event) {
        console.log('连接关闭');
        websocket = null;
    }
    websocket.onerror = function () {
        alert('websocket通信发生错误！');
    }

    websocket4Room.onclose = function() {
        console.log('websocket4Room connection closed - room');
        websocket4Room = null;
    };
    websocket4Room.onerror = function(error) {
        console.error('websocket4Room error - room:', error);
    };

    websocket.onmessage = function (event) {
        let m = event.data;
        let msgCode = getQueryParam("msgCode");
        let isRedSide = msgCode === "60";

        switch (m) {
            case '100':
                alert(isRedSide ? "你赢了！" : "对手赢了！");
                document.getElementById("answer").style.visibility = "visible";
                break;

            case '200':
                alert(isRedSide ? "对手赢了！" : "你赢了！");
                document.getElementById("answer").style.visibility = "visible";
                break;

            case '300':
                document.getElementById("point").style.visibility = "visible";
                break;

            default:
                // 处理卡牌变灰
                let cardNum = parseInt(m);
                let buttonId;
                if ((cardNum <= 10 && isRedSide) || (cardNum > 10 && !isRedSide)) {
                    // 自己出的牌
                    buttonId = 'my' + (cardNum <= 10 ? cardNum : cardNum - 10);
                } else {
                    // 对手出的牌
                    buttonId = 'opp' + (cardNum <= 10 ? cardNum : cardNum - 10);
                }
                document.getElementById(buttonId).style.backgroundColor = "grey";
                document.getElementById(buttonId).disabled = true;
                break;
        }
    };

    // 房主的页面接收 人员到齐！
    websocket4Room.onmessage = function (event) {
        // 解析接收到的消息
        let data = JSON.parse(event.data);
        console.log('来自房间控制的消息:', data);
        let redUser = data[1];   // 红色方玩家数据
        let m = redUser.msgCode;  // 60

        switch (m) {
           case '60':
                    redSideJoin(redUser); // 红方加入游戏，显示对手信息
                    break;

            default:
                break;
        }
    };

    // 出牌
    function sendCard(cardId) {
        let msgCode = getQueryParam("msgCode");
        let actualCardId = msgCode === "60" ? cardId : (cardId + 10); // 根据角色调整实际的卡牌ID
        
        document.getElementById('my' + cardId).disabled = true;

        let playerData = {
            nickName: getQueryParam(msgCode === "60" ? "redNickName" : "blueNickName"),
            role: msgCode === "60" ? "redSide" : "blueSide",
            deviceId: deviceId,
            card: actualCardId
        };

        websocket.send(JSON.stringify(playerData));
        document.getElementById("point").style.visibility = "hidden";
    }

    // 获取 URL 中的查询参数
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    // 页面加载完成时获取参数并显示信息
    window.onload = function() {
        let msgCode = getQueryParam("msgCode");
        let isRedSide = msgCode === "60";
        let myNickName, myWinRate, opponentNickName, opponentWinRate;

        if (isRedSide) {
            // 如果是红方
            myNickName = getQueryParam("redNickName");
            myWinRate = getQueryParam("redWinRate");
            opponentNickName = getQueryParam("blueNickName");
            opponentWinRate = getQueryParam("blueWinRate");
        } else {
            // 如果是蓝方
            myNickName = getQueryParam("blueNickName");
            myWinRate = getQueryParam("blueWinRate");
            document.getElementById("waitAnotherPlayer").style.visibility = "visible";
        }

        // 显示玩家信息
        document.getElementById("myName").textContent = `我: ${myNickName}`;
        document.getElementById("myWinRate").textContent = `胜率: ${myWinRate}%`;
        
        if (opponentNickName) {
            document.getElementById("opponentName").textContent = `对手: ${opponentNickName}`;
            document.getElementById("opponentWinRate").textContent = `胜率: ${opponentWinRate}%`;
        }

        // 显示牌面
        document.getElementById("mySide").style.visibility = "visible";
        if (opponentNickName) {
            document.getElementById("opponentSide").style.visibility = "visible";
        }
    };

    function redSideJoin(redUser) {
        let msgCode = getQueryParam("msgCode");
        if (msgCode === "50") { // 蓝方玩家
            document.getElementById("waitAnotherPlayer").style.visibility = "hidden";
            document.getElementById("opponentName").textContent = `对手: ${redUser.nickName}`;
            document.getElementById("opponentWinRate").textContent = `胜率: ${redUser.winRate}%`;
            document.getElementById("opponentSide").style.visibility = "visible";
        }
    }

    window.onbeforeunload = function () {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.close();
        }
        if (websocket4Room && websocket4Room.readyState === WebSocket.OPEN) {
            websocket4Room.close();
        }
    };

</script>

</body>
</html>