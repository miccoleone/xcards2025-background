<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºå•†å¤§ä½œæˆ˜</title>
    <script src="./js/uuid.min.js"></script>
    <script src="./util/utils.js"></script>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/mystyle.css" rel="stylesheet">
    <script src="./js/jquery-3.1.1.min.js"></script>
    <script src="./js/bootstrap3.0.3.min.js"></script>
    <script src="./js/html2canvas.min.js"></script>
</head>
<body>
<div id="roomPage" class="page active">
    <div class="game-container">
        <h1>æ™ºå•†å¤§ä½œæˆ˜</h1>
        <div class="game-tip">è¾“å…¥ç›¸åŒæˆ¿é—´å·å³å¯è”æœºå¯¹æˆ˜</div>
        <div class="input-container">
            <input type="number" id="roomCodeInput" placeholder="è¯·è¾“å…¥æˆ¿é—´å·" autofocus>
            <button id="joinBtn">è¿›å…¥æ¸¸æˆ</button>
        </div>
        <div id="loadingMessage" style="display: none; color: #333; font-size: 18px; margin-top: 20px;">
            æ­£åœ¨è¿›å…¥æˆ¿é—´...
        </div>
    </div>
    <div class="room-full-tip" id="roomFullTip">
        æˆ¿é—´å·²æ»¡
    </div>
</div>

<div id="gamePage" class="page">
    <div class="home-icon" onclick="goHome()">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" fill="currentColor"/>
        </svg>
    </div>
    <div class="share-icon" onclick="shareGame()">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z" fill="currentColor"/>
        </svg>
    </div>
    <div class="container-fluid">
        <div class="row clearfix" style="text-align: center">
            <div id="opponentSide" style="display: none;">
                <div class="col-md-24 column">
                    <br>
                    <div class="userVO-name" style="color: red" id="opponentName"></div>
                    <div id="opponentWinRate"></div>
                    <br>
                    <div class="card-side">
                        <button id="opp1" type="button" class="btn btn-default opponent-card">1</button>
                        <button id="opp2" type="button" class="btn btn-default opponent-card">2</button>
                        <button id="opp3" type="button" class="btn btn-default opponent-card">3</button>
                        <button id="opp4" type="button" class="btn btn-default opponent-card">4</button>
                        <button id="opp5" type="button" class="btn btn-default opponent-card">5</button>
                    </div>
                </div>
                <br>
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="opp6" type="button" class="btn btn-default  opponent-card">6</button>
                        <button id="opp7" type="button" class="btn btn-default opponent-card">7</button>
                        <button id="opp8" type="button" class="btn btn-default opponent-card">8</button>
                        <button id="opp9" type="button" class="btn btn-default opponent-card">9</button>
                        <button id="opp10" type="button" class="btn btn-default opponent-card">10</button>
                    </div>
                </div>
            </div>

            <div id="centerSide">
                <br>
                <br>
                <div id="waitAnotherPlayer" style="display: none;">
                    <button type="button" class="btn btn-primary">ç­‰å¾…å¯¹æ‰‹è¿›å…¥...</button>
                </div>
                <div id="rematchRequest" style="display: none;">
                    <p style="margin-bottom: 15px;color:#4CAF50FF;">å¯¹æ‰‹è¯·æ±‚ç»§ç»­æ¸¸æˆ</p>
                    <div class="button-group">
                        <button onclick="rejectRematch()" class="btn-secondary-action">æ‹’ç»</button>
                        <button onclick="acceptRematch()" class="btn-primary-action">æ¥å—</button>
                    </div>
                </div>
                <div id="point" style="display: none;">
                    <label style="color:#4CAF50FF;">å¯¹æ–¹å·²è½å®š</label>
                </div>
                <br>
                <br>
            </div>

            <div id="mySide" style="display: none;">
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="my1" type="button" class="btn btn-default" onclick="sendCard(1)">1</button>
                        <button id="my2" type="button" class="btn btn-default" onclick="sendCard(2)">2</button>
                        <button id="my3" type="button" class="btn btn-default" onclick="sendCard(3)">3</button>
                        <button id="my4" type="button" class="btn btn-default" onclick="sendCard(4)">4</button>
                        <button id="my5" type="button" class="btn btn-default" onclick="sendCard(5)">5</button>
                    </div>
                </div>
                <br>
                <div class="col-md-24 column">
                    <div class="card-side">
                        <button id="my6" type="button" class="btn btn-default" onclick="sendCard(6)">6</button>
                        <button id="my7" type="button" class="btn btn-default" onclick="sendCard(7)">7</button>
                        <button id="my8" type="button" class="btn btn-default" onclick="sendCard(8)">8</button>
                        <button id="my9" type="button" class="btn btn-default" onclick="sendCard(9)">9</button>
                        <button id="my10" type="button" class="btn btn-default" onclick="sendCard(10)">10</button>
                    </div>
                </div>
                <br>
                <div class="userVO-name" id="myName">æˆ‘</div>
                <div id="myWinRate"></div>
            </div>
        </div>
    </div>
</div>

<audio id="footstepSound" preload="auto">
    <source src="audio/footstep.mp3" type="audio/mpeg">
</audio>
<audio id="sendCardSound" preload="auto">
    <source src="audio/sendCard.mp3" type="audio/mpeg">
</audio>
<audio id="startSound" preload="auto">
    <source src="audio/start.mp3" type="audio/mpeg">
</audio>
<audio id="clickSound" preload="auto">
    <source src="audio/click.mp3" type="audio/mpeg">
</audio>
<audio id="victorySound" preload="auto">
    <source src="audio/victory.mp3" type="audio/mpeg">
</audio>
<audio id="defeatSound" preload="auto">
    <source src="audio/defeat.mp3" type="audio/mpeg">
</audio>

<script>
    let matchSocket = null;
    const openId = localStorage.getItem("openId") || new Date().getTime();
    localStorage.setItem("openId", openId);

    function showPage(pageId) {
        $('.page').removeClass('active');
        $(`#${pageId}`).addClass('active');
    }

    function initWebSocket() {
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            matchSocket = new WebSocket(`${protocol}//${host}/match?openId=${openId}`);

            console.log('Attempting to connect to match WebSocket...');

            matchSocket.onopen = () => {
                console.log('Match WebSocket connected successfully');
            };

            matchSocket.onerror = (error) => {
                console.error('Match WebSocket error:', error);
                alert('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                goHome();
            };

            matchSocket.onclose = () => {
                console.log('Match WebSocket connection closed');
                alert('ç©å®¶ç¦»å¼€äº†æˆ¿é—´');
                goHome();
            };

            matchSocket.onmessage = (event) => {
                handleMessage(event);
            };
        } catch (error) {
            console.error('Error creating match WebSocket:', error);
        }
    }

    function handleMessage(event) {
        console.log('Message received:', event.data);
        try {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'room_state':
                    showPage('gamePage');
                    const players = data.players;
                    const myData = players.find(user => user.openId == openId);
                    const opponentData = players.find(user => user.openId != openId);

                    window.playerRole = myData.role;

                    if (myData) {
                        $('#mySide').show();
                        $('#myName').text('æˆ‘ï¼š' + myData.nickName);
                        $('#myWinRate').text('èƒœç‡: ' + (myData.winRate || 0) + '%');

                        if (myData.role === 'blueSide' && players.length === 1) {
                            $('#waitAnotherPlayer').show();
                            $('#waitAnotherPlayer button').text('ç­‰å¾…å¯¹æ‰‹è¿›å…¥....');
                            disableAllCards();
                        }
                    }

                    if (players.length === 2 && opponentData) {
                        $('#opponentSide').show();
                        $('#opponentName').text('å¯¹æ‰‹ï¼š' + opponentData.nickName);
                        $('#opponentWinRate').text('èƒœç‡: ' + (opponentData.winRate || 0) + '%');
                    }
                    break;

                case 'room_full':
                    $('#loadingMessage').hide();
                    $('#joinBtn').prop('disabled', false);
                    $('#roomCodeInput').prop('disabled', false);
                    $('#roomFullTip').addClass('show');
                    setTimeout(() => {
                        $('#roomFullTip').removeClass('show');
                    }, 3000);
                    break;

                case 'game_ready':
                    console.log('æ”¶åˆ°game_readyæ¶ˆæ¯ï¼Œæ¸¸æˆå‡†å¤‡å¼€å§‹');
                    showPage('gamePage');
                    
                    const readyPlayers = data.players;
                    if (readyPlayers && readyPlayers.length === 2) {
                        const myPlayerData = readyPlayers.find(user => user.openId == openId);
                        const opponentPlayerData = readyPlayers.find(user => user.openId != openId);

                        if (myPlayerData) {
                            window.playerRole = myPlayerData.role;
                            $('#mySide').show();
                            $('#myName').text('æˆ‘ï¼š' + myPlayerData.nickName);
                            $('#myWinRate').text('èƒœç‡: ' + (myPlayerData.winRate || 0) + '%');
                        }

                        if (opponentPlayerData) {
                            $('#opponentSide').show();
                            $('#opponentName').text('å¯¹æ‰‹ï¼š' + opponentPlayerData.nickName);
                            $('#opponentWinRate').text('èƒœç‡: ' + (opponentPlayerData.winRate || 0) + '%');
                        }
                    }
                    
                    $('#waitAnotherPlayer').hide();
                    showGameStart();
                    resetGameState4Begin();
                    break;

                case 'game_start':
                    $('#waitAnotherPlayer').hide();
                    showGameStart();
                    resetGameState4Begin();
                    break;

                case 'round_complete':
                    const myCard = data.myCard;
                    const oppCard = data.oppCard;
                    $(`#opp${oppCard}`).addClass('flip');
                    playCardSound();
                    enableRemainingCards();
                    break;

                case 'please_take_card':
                    $('#point').show();
                    playFootstepSound();
                    enableRemainingCards();
                    break;

                case 'game_result':
                    setTimeout(() => {
                        switch (data.result) {
                            case 'red_win':
                                showGameResult(window.playerRole === 'redSide');
                                break;
                            case 'blue_win':
                                showGameResult(window.playerRole === 'blueSide');
                                break;
                            case 'draw':
                                showGameResult(null);
                                break;
                        }
                    }, 1500);
                    break;

                case 'rematch_request':
                    $('#resultOverlay').removeClass('visible');
                    $('#rematchRequest').show();
                    $('.game-options').remove();
                    break;

                case 'rematch_accept':
                    // âœ… æ³¨æ„ï¼šåç«¯ç°åœ¨åœ¨handleRematchAcceptä¸­å‘é€game_readyæ¶ˆæ¯
                    // è¿™é‡Œä¿æŒå…¼å®¹æ€§ï¼Œå¤„ç†å¯èƒ½çš„rematch_acceptæ¶ˆæ¯
                    $('#point').hide();
                    $('#waitAnotherPlayer').hide();
                    $('.game-options').remove();
                    $('#opponentSide').show();
                    enableAllCards();
                    const startOverlay = document.getElementById('startOverlay');
                    startOverlay.classList.add('show');
                    playStartSound();
                    setTimeout(() => {
                        startOverlay.classList.remove('show');
                    }, 2000);
                    break;

                case 'opponent_leave':
                    alert(data.message);
                    goHome();
                    break;

                case 'share':
                    window.hasShareNotice = true;
                    window.shareTitle = data.title;
                    window.winnerName = data.winnerName;
                    window.loserName = data.loserName;
                    break;

                default:
                    console.warn('Unknown message type:', data.type);
            }
        } catch (error) {
            console.error('Error handling message:', error);
        }
    }

    function showGameStart() {
        $('#startOverlay').addClass('show');
        playStartSound();
        setTimeout(() => {
            $('#startOverlay').removeClass('show');
        }, 2000);
    }

    function showGameResult(isWinner) {
        const modal = document.getElementById('resultOverlay');
        const resultText = document.getElementById('resultText');

        if (isWinner === null) {
            resultText.textContent = 'åŒèµ¢';
        } else {
            resultText.textContent = isWinner ? 'èƒœåˆ©' : 'å¤±è´¥';
            if (isWinner) {
                playVictorySound();
            } else {
                playDefeatSound();
            }
            disableAllCards();
            $('#mySide').addClass('game-completed');
        }

        $('.home-icon').show();

        function showGameOptions(isWinner) {
            const gameOptions = `
                    <div class="game-options">
                        <div class="button-group">
                            <button onclick="leaveRoomToHome()" class="btn btn-secondary-action">ä¸»é¡µ</button>
                            <button onclick="requestRematch()" class="btn-primary-action">
                                ${isWinner ? 'ç»§ç»­æ¸¸æˆ' : 'ä¸æœå†æˆ˜'}
                            </button>
                        </div>
                    </div>
                `;
            $('#centerSide').append(gameOptions);
        }

        showGameOptions(isWinner);
        modal.classList.add('visible');
    }

    function closeResult() {
        const modal = document.getElementById('resultOverlay');
        modal.classList.remove('visible');
        if (window.hasShareNotice) {
            $('.share-icon').addClass('visible')
                .data('shareTitle', window.shareTitle)
                .data('winnerName', window.winnerName)
                .data('loserName', window.loserName);
            setTimeout(() => {
                const shareNotice = `
                        <div class="share-notice">
                            <p>${window.shareTitle}</p>
                            <p>ç‚¹å‡»å·¦ä¸Šè§’ä¿å­˜æˆ˜ç»©æˆªå›¾</p>
                        </div>
                    `;
                $('.share-notice').remove();
                const $notice = $(shareNotice).appendTo('#centerSide');
                setTimeout(() => {
                    $notice.fadeOut(500, function() {
                        $(this).remove();
                    });
                }, 5000);

                window.hasShareNotice = false;
                window.shareTitle = null;
                window.winnerName = null;
                window.loserName = null;
            }, 200);
        }
    }

    function playVictorySound() {
        const sound = document.getElementById('victorySound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function playDefeatSound() {
        const sound = document.getElementById('defeatSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function playStartSound() {
        const sound = document.getElementById('startSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function playCardSound() {
        const sound = document.getElementById('sendCardSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function playFootstepSound() {
        const sound = document.getElementById('footstepSound');
        sound.volume = 0.5;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function initializeGamePage() {
        $('#opponentSide').hide();
        $('#mySide').hide();
        $('#waitAnotherPlayer').hide();
        $('#answer').hide();
        $('#rematchRequest').hide();
        $('#point').hide();
        $('#resultOverlay').removeClass('show');
        $('.home-icon').hide();
        $('.card-side button').removeClass('flip');
        $('.card-side button').prop('disabled', false);
    }

    $(document).ready(function() {
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ– ğŸ”¥ğŸ”¥ğŸ”¥');
        
        initializeGamePage();
        initWebSocket();

        function toggleTip() {
            const tip = $('.game-tip');
            tip.addClass('show');
            setTimeout(() => {
                tip.removeClass('show');
            }, 7000);
        }

        setTimeout(() => {
            toggleTip();
            setInterval(toggleTip, 10000);
        }, 2000);

        $('#roomCodeInput').keypress(function(e) {
            if (e.which === 13) {
                $('#joinBtn').click();
            }
        });

        // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ï¼šç»‘å®šè¿›å…¥æ¸¸æˆæŒ‰é’®äº‹ä»¶ ğŸ”¥ğŸ”¥ğŸ”¥
        $('#joinBtn').off('click').on('click', function() {
            console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ç‚¹å‡»è¿›å…¥æ¸¸æˆæŒ‰é’® ğŸ”¥ğŸ”¥ğŸ”¥');
            
            let roomCode = $('#roomCodeInput').val().trim();
            console.log('æˆ¿é—´å·:', roomCode);
            
            if (!roomCode) {
                alert("è¯·è¾“å…¥æˆ¿é—´å·ï¼");
                return;
            }

            if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
                console.error('WebSocket not connected. State:', matchSocket ? matchSocket.readyState : 'null');
                alert("æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨åé‡è¯•...");
                initWebSocket();
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            $('#joinBtn').prop('disabled', true);
            $('#roomCodeInput').prop('disabled', true);
            
            console.log('ğŸ”¥ğŸ”¥ğŸ”¥ æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ˜µç§° ğŸ”¥ğŸ”¥ğŸ”¥');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„æ˜µç§°
            const savedNickname = localStorage.getItem("nickname");
            console.log('ä¿å­˜çš„æ˜µç§°:', savedNickname);
            
            if (savedNickname && savedNickname.trim()) {
                console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ä½¿ç”¨ä¿å­˜çš„æ˜µç§°ç›´æ¥åŠ å…¥æˆ¿é—´ ğŸ”¥ğŸ”¥ğŸ”¥');
                // ç›´æ¥ä½¿ç”¨ä¿å­˜çš„æ˜µç§°åŠ å…¥æˆ¿é—´
                const message = {
                    type: "join_room",
                    openId: openId,
                    roomCode: roomCode,
                    nickName: savedNickname.trim()
                };
                
                console.log('å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚:', message);
                matchSocket.send(JSON.stringify(message));
                $('#loadingMessage').show();
            } else {
                console.log('ğŸ”¥ğŸ”¥ğŸ”¥ æ²¡æœ‰ä¿å­˜çš„æ˜µç§°ï¼Œæ˜¾ç¤ºè¾“å…¥æ¨¡æ€æ¡† ğŸ”¥ğŸ”¥ğŸ”¥');
                // æ˜¾ç¤ºæ˜µç§°è¾“å…¥æ¨¡æ€æ¡†
                showNicknameModal(roomCode);
            }
            
            // ğŸ”¥ğŸ”¥ğŸ”¥ é‡è¦ï¼šé˜»æ­¢ä»»ä½•å¯èƒ½çš„ç›´æ¥åŠ å…¥æˆ¿é—´çš„è¡Œä¸º ğŸ”¥ğŸ”¥ğŸ”¥
            return false;
        });
        
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ äº‹ä»¶ç»‘å®šå®Œæˆ ğŸ”¥ğŸ”¥ğŸ”¥');
    });

    function playClickSound() {
        const sound = document.getElementById('clickSound');
        sound.volume = 0.7;
        sound.currentTime = 0;
        sound.play().catch(e => console.log('æ’­æ”¾éŸ³æ•ˆå¤±è´¥:', e));
    }

    function showNicknameModal(roomCode) {
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ === æ˜¾ç¤ºæ˜µç§°è¾“å…¥æ¨¡æ€æ¡† === ğŸ”¥ğŸ”¥ğŸ”¥');
        console.log('æˆ¿é—´å·:', roomCode);
        
        // ç¡®ä¿æ¨¡æ€æ¡†å­˜åœ¨
        const modalElement = $('#nicknameModal');
        console.log('æ¨¡æ€æ¡†å…ƒç´ æ•°é‡:', modalElement.length);
        
        if (modalElement.length === 0) {
            console.error('ğŸš¨ğŸš¨ğŸš¨ æ˜µç§°æ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼ğŸš¨ğŸš¨ğŸš¨');
            alert('ç³»ç»Ÿé”™è¯¯ï¼šæ˜µç§°è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼');
            return;
        }
        
        console.log('æ˜¾ç¤ºæ¨¡æ€æ¡†...');
        modalElement.show();
        
        const inputElement = $('#nicknameInput');
        console.log('è¾“å…¥æ¡†å…ƒç´ æ•°é‡:', inputElement.length);
        inputElement.val('').focus();
        
        $('#nicknameError').hide();
        $('#nicknameLoading').hide();
        
        console.log('ç»‘å®šäº‹ä»¶...');
        
        // ç»‘å®šç¡®è®¤æŒ‰é’®äº‹ä»¶
        $('#nicknameConfirm').off('click').on('click', function() {
            console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ç‚¹å‡»ç¡®è®¤æŒ‰é’® ğŸ”¥ğŸ”¥ğŸ”¥');
            handleNicknameConfirm(roomCode);
        });
        
        // ç»‘å®šæ¸¸å®¢æŒ‰é’®äº‹ä»¶
        $('#nicknameGuest').off('click').on('click', function() {
            console.log('ğŸ”¥ğŸ”¥ğŸ”¥ ç‚¹å‡»æ¸¸å®¢æŒ‰é’® ğŸ”¥ğŸ”¥ğŸ”¥');
            // ç”Ÿæˆéšæœºæ¸¸å®¢æ˜µç§°
            const guestNickname = 'æ¸¸å®¢' + Math.floor(Math.random() * 10000);
            console.log('ç”Ÿæˆæ¸¸å®¢æ˜µç§°:', guestNickname);
            
            // ç›´æ¥ä½¿ç”¨æ¸¸å®¢æ˜µç§°ï¼Œæ— éœ€æ£€æŸ¥
            localStorage.setItem("nickname", guestNickname);
            
            const message = {
                type: "join_room",
                openId: openId,
                roomCode: roomCode,
                nickName: guestNickname
            };
            
            console.log('å‘é€æ¸¸å®¢åŠ å…¥æˆ¿é—´è¯·æ±‚:', message);
            matchSocket.send(JSON.stringify(message));
            playClickSound();
            $('#loadingMessage').show();
            hideNicknameModal();
        });
        
        // ç»‘å®šå›è½¦é”®äº‹ä»¶
        $('#nicknameInput').off('keypress').on('keypress', function(e) {
            if (e.which === 13) {
                console.log('ğŸ”¥ğŸ”¥ğŸ”¥ æŒ‰ä¸‹å›è½¦é”® ğŸ”¥ğŸ”¥ğŸ”¥');
                handleNicknameConfirm(roomCode);
            }
        });
        
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®šå®Œæˆ ğŸ”¥ğŸ”¥ğŸ”¥');
        
        // æ£€æŸ¥æ¨¡æ€æ¡†æ˜¯å¦çœŸçš„æ˜¾ç¤ºäº†
        setTimeout(() => {
            const isVisible = modalElement.is(':visible');
            console.log('æ¨¡æ€æ¡†æ˜¯å¦å¯è§:', isVisible);
            if (!isVisible) {
                console.error('ğŸš¨ğŸš¨ğŸš¨ æ¨¡æ€æ¡†æ˜¾ç¤ºå¤±è´¥ï¼ğŸš¨ğŸš¨ğŸš¨');
            }
        }, 100);
    }
    
    function hideNicknameModal() {
        $('#nicknameModal').hide();
        $('#nicknameInput').val('');
        $('#joinBtn').prop('disabled', false);
        $('#roomCodeInput').prop('disabled', false);
    }
    
    async function handleNicknameConfirm(roomCode) {
        console.log('=== å¼€å§‹å¤„ç†æ˜µç§°ç¡®è®¤ ===');
        const nickname = $('#nicknameInput').val().trim();
        console.log('è¾“å…¥çš„æ˜µç§°:', nickname);
        
        if (!nickname) {
            console.log('æ˜µç§°ä¸ºç©º');
            $('#nicknameError').text('æ˜µç§°ä¸èƒ½ä¸ºç©º').show();
            return;
        }
        
        console.log('å¼€å§‹æ£€æŸ¥æ˜µç§°:', nickname);
        
        // å…ˆè¿›è¡Œæœ¬åœ°åŸºç¡€æ£€æŸ¥
        const isLocalSafe = isBasicNicknameSafe(nickname);
        console.log('æœ¬åœ°æ£€æŸ¥ç»“æœ:', isLocalSafe);
        
        if (!isLocalSafe) {
            console.log('æœ¬åœ°æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯');
            $('#nicknameError').text('æ˜µç§°åŒ…å«ä¸å½“å†…å®¹ï¼Œè¯·é‡æ–°è¾“å…¥').show();
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        console.log('æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
        $('#nicknameError').hide();
        $('#nicknameLoading').show();
        $('#nicknameConfirm').prop('disabled', true);
        
        try {
            console.log('è°ƒç”¨æœåŠ¡å™¨æ£€æŸ¥API');
            const isValid = await checkNicknameWithServer(nickname);
            console.log('æœåŠ¡å™¨æ£€æŸ¥ç»“æœ:', isValid);
            
            if (isValid) {
                console.log('æ˜µç§°æ£€æŸ¥é€šè¿‡ï¼Œå‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚');
                localStorage.setItem("nickname", nickname);
                
                // å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚
                let playerData = {
                    type: "join_room",
                    openId: openId,
                    roomCode: roomCode,
                    nickName: nickname
                };
                
                console.log('å‘é€çš„æ•°æ®:', playerData);
                matchSocket.send(JSON.stringify(playerData));
                console.log('Join request sent successfully');
                playClickSound();
                $('#loadingMessage').show();
                hideNicknameModal();
            } else {
                console.log('æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯');
                $('#nicknameError').text('æ˜µç§°åŒ…å«ä¸å½“å†…å®¹ï¼Œè¯·é‡æ–°è¾“å…¥').show();
            }
        } catch (error) {
            console.error('æ˜µç§°æ£€æŸ¥APIè°ƒç”¨å¤±è´¥:', error);
            $('#nicknameError').text('æ˜µç§°æ£€æŸ¥æœåŠ¡å¼‚å¸¸ï¼Œè¯·é‡æ–°è¾“å…¥').show();
        } finally {
            console.log('æ¢å¤UIçŠ¶æ€');
            $('#nicknameLoading').hide();
            $('#nicknameConfirm').prop('disabled', false);
        }
    }
    
    async function checkNicknameWithServer(nickname) {
        console.log('ğŸ”¥ğŸ”¥ğŸ”¥ å¼€å§‹æ ¡éªŒæ˜µç§°:', nickname);
        
        // éç©ºæ ¡éªŒ
        if (!nickname || nickname.trim() === '') {
            console.log('âŒ æ˜µç§°ä¸ºç©ºï¼Œæ ¡éªŒå¤±è´¥');
            return false;
        }
        
        try {
            console.log('ğŸ“¡ è°ƒç”¨åç«¯æ˜µç§°æ ¡éªŒæ¥å£...');
            const response = await fetch('/api/check-nickname', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nickname: nickname,
                    openId: openId
                })
            });
            
            console.log('ğŸ“¡ åç«¯å“åº”çŠ¶æ€:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('ğŸ¯ åç«¯å“åº”ç»“æœ:', result);
            
            if (result.success) {
                console.log('âœ… æ˜µç§°æ ¡éªŒé€šè¿‡:', result.message);
                return true;
            } else {
                console.log('âŒ æ˜µç§°æ ¡éªŒå¤±è´¥:', result.message);
                return false;
            }
        } catch (error) {
            console.error('ğŸ’¥ åç«¯APIè°ƒç”¨å¼‚å¸¸:', error);
            return true; // å¼‚å¸¸æ—¶é™çº§å¤„ç†
        }
    }
    
    function isBasicNicknameSafe(nickname) {
        console.log('è¿›è¡Œæœ¬åœ°æ˜µç§°å®‰å…¨æ£€æŸ¥:', nickname);
        
        // åŸºç¡€çš„å‰ç«¯æ£€æŸ¥
        if (nickname.length > 20 || nickname.length < 1) {
            console.log('æ˜µç§°é•¿åº¦ä¸ç¬¦åˆè¦æ±‚:', nickname.length);
            return false;
        }
        
        // ç®€åŒ–çš„æœ¬åœ°æ•æ„Ÿè¯åˆ—è¡¨ï¼Œä¸»è¦ä¾èµ–è¿œç¨‹æ ¡éªŒ
        const forbiddenWords = ['ç®¡ç†å‘˜', 'å®¢æœ', 'ç³»ç»Ÿ', 'å®˜æ–¹'];
        const lowerNickname = nickname.toLowerCase();
        
        for (let word of forbiddenWords) {
            if (lowerNickname.includes(word.toLowerCase())) {
                console.log('å‘ç°æ•æ„Ÿè¯:', word, 'åœ¨æ˜µç§°:', nickname);
                return false;
            }
        }
        
        console.log('æœ¬åœ°æ˜µç§°æ£€æŸ¥é€šè¿‡:', nickname);
        return true;
    }

    function sendCard(card) {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            console.error('Match WebSocket not connected');
            return;
        }

        try {
            playCardSound();
            $('.card-side button:not(.flip)').prop('disabled', true);
            $('#point').hide();
            $(`#my${card}`).addClass('flip');

            const message = {
                type: "play_card",
                openId: openId,
                card: card
            };
            matchSocket.send(JSON.stringify(message));
        } catch (error) {
            console.error('Error sending card:', error);
            enableRemainingCards();
        }
    }

    function disableAllCards() {
        for (let i = 1; i <= 10; i++) {
            $(`#my${i}`).prop('disabled', true).addClass('disabled');
        }
    }

    function enableRemainingCards() {
        for (let i = 1; i <= 10; i++) {
            const card = $(`#my${i}`);
            if (!card.hasClass('flip')) {
                card.prop('disabled', false);
            }
        }
    }

    function resetGameState4Begin() {
        $('.card-side button').removeClass('flip disabled');
        $('#mySide .card-side button').prop('disabled', false);
    }

    function resetGameState() {
        $('.card-side button').removeClass('flip disabled');
        $('#mySide').removeClass('game-completed');
        $('.card-side button').prop('disabled', false);
        $('#resultOverlay').removeClass('visible');
        $('#point').hide();
        $('.home-icon').hide();
    }

    function goHome() {
        showPage('roomPage');
        resetGameState();
        $('#opponentSide').hide();
        $('#mySide').hide();
        $('#waitAnotherPlayer').hide();
        $('.game-options').remove();
        $('#roomCodeInput').val('').prop('disabled', false);
        $('#joinBtn').prop('disabled', false);
        $('#loadingMessage').hide();

        if (matchSocket && matchSocket.readyState === WebSocket.OPEN) {
            const message = {
                type: "leave_room",
                openId: openId
            };
            matchSocket.send(JSON.stringify(message));
            matchSocket.close();
        }
    }

    function leaveRoomToHome() {
        goHome();
    }

    function requestRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("ç©å®¶ç¦»å¼€äº†æˆ¿é—´");
            goHome();
            return;
        }

        const message = {
            type: "rematch_request",
            openId: openId
        };
        matchSocket.send(JSON.stringify(message));

        resetGameState();
        disableAllCards();
        $('.game-options').remove();
        $('#waitAnotherPlayer').hide();
        $('#opponentSide').hide();
        $('#waitAnotherPlayer').show().find('button').text('ç­‰å¾…å¯¹æ‰‹å“åº”...');
    }

    function shareGame() {
        const shareIcon = $('.share-icon');
        const title = shareIcon.data('shareTitle');
        const winnerName = shareIcon.data('winnerName');
        const loserName = shareIcon.data('loserName');

        const shareContent = document.createElement('div');
        shareContent.className = 'share-content';
        shareContent.innerHTML = `
                <div class="share-header">
                    <img src="image/game-icon.png" class="game-icon" alt="ä¹‰çˆ¶">
                    <span>åå¼ ç‰Œ</span>
                </div>
                <div class="share-main">
                    <div class="share-title">ä½ æœªæ›¾è’™é¢çš„ä¹‰çˆ¶</div>
                    <div class="share-image">
                        <img src="image/yifu.png" class="main-img" alt="ä¹‰çˆ¶">
                        <div class="winner-name">${winnerName}</div>
                        <div class="loser-name">${loserName}</div>
                        <div class="timestamp">${getCurrentTimestamp()}</div>
                    </div>
                </div>
                <div class="share-link">
                    <span>æ™ºå•†å¤§ä½œæˆ˜ å’Œä½ çš„å¥½å‹å¯¹æˆ˜å§ï¼</span>
                </div>
            `;

        document.body.appendChild(shareContent);

        html2canvas(shareContent, {
            useCORS: true,
            backgroundColor: null
        }).then(canvas => {
            try {
                const imgUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = 'æ¸¸æˆæˆ˜ç»©.png';
                link.href = imgUrl;
                link.click();
            } catch (error) {
                console.error('Error generating share image:', error);
                alert('ç”Ÿæˆåˆ†äº«å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                document.body.removeChild(shareContent);
            }
        }).catch(error => {
            console.error('Error with html2canvas:', error);
            alert('ç”Ÿæˆåˆ†äº«å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            document.body.removeChild(shareContent);
        });
    }

    function getCurrentTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}${month}${day} ${hours}:${minutes}`;
    }

    function acceptRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("ç©å®¶ç¦»å¼€äº†æˆ¿é—´");
            goHome();
            return;
        }

        const message = {
            type: "rematch_accept",
            openId: openId
        };
        matchSocket.send(JSON.stringify(message));
        $('#rematchRequest').hide();
        $('#waitAnotherPlayer').hide();
        resetGameState();
    }

    function rejectRematch() {
        if (!matchSocket || matchSocket.readyState !== WebSocket.OPEN) {
            alert("ç©å®¶ç¦»å¼€äº†æˆ¿é—´");
            goHome();
            return;
        }

        const message = {
            type: "rematch_reject",
            openId: openId
        };
        matchSocket.send(JSON.stringify(message));
        $('#rematchRequest').hide();

        const gameOptions = `
                <div class="game-options">
                    <button onclick="goHome()" class="btn btn-primary">è¿”å›ä¸»é¡µ</button>
                </div>
            `;
        $('#centerSide').append(gameOptions);
    }

    function enableAllCards() {
        for (let i = 1; i <= 10; i++) {
            $(`#my${i}`).prop('disabled', false).removeClass('disabled');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem('openId')) {
            localStorage.setItem('openId', new Date().getTime());
        }
    });
</script>

<div class="game-result-modal" id="resultOverlay">
    <div class="modal-content">
        <h2 id="resultText"></h2>
        <button onclick="closeResult()" class="confirm-btn">ç¡®è®¤</button>
    </div>
</div>

<div class="start-overlay" id="startOverlay">
    <div class="start-text">æ¸¸æˆå¼€å§‹</div>
</div>

<!-- æ˜µç§°è¾“å…¥æ¨¡æ€æ¡† -->
<div id="nicknameModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 300px; text-align: center;">
        <h3 style="margin-bottom: 20px; color: #333;">è¯·è¾“å…¥æ‚¨çš„æ˜µç§°</h3>
        <input type="text" id="nicknameInput" placeholder="è¯·è¾“å…¥æ˜µç§°" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; font-size: 16px;">
        <div id="nicknameError" style="color: red; margin-bottom: 15px; display: none;"></div>
        <div id="nicknameLoading" style="color: #666; margin-bottom: 15px; display: none;">æ­£åœ¨æ£€æŸ¥æ˜µç§°...</div>
        <div style="text-align: center;">
            <button id="nicknameGuest" style="background: #ff9800; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">æ¸¸å®¢</button>
            <button id="nicknameConfirm" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">ç¡®è®¤</button>
        </div>
    </div>
</div>

</body>
</html>