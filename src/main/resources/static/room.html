<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
    <script src="./util/utils.js"></script>
    <title>十张牌 - 输入房间号</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }
        .game-container {
            text-align: center;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }
        .game-container h1 {
            margin-bottom: 20px;
            color: #333;
        }
        .input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-container input {
            width: 60%;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .input-container button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }
        .input-container button:hover {
            background-color: #45a049;
        }
        .status-message {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
        }
        /* 添加房间已满提示层样式 */
        .room-full-tip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out;
        }

        .room-full-tip.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1>十张牌</h1>
    <div class="input-container">
        <input type="number" id="roomCodeInput" placeholder="请输入房间号" autofocus>
        <button id="joinBtn">进入游戏</button>
    </div>
    <div id="loadingMessage" style="display: none; color: #333; font-size: 18px; margin-top: 20px;">
        正在进入房间...
    </div>
</div>

<div class="room-full-tip" id="roomFullTip">
    房间已满
</div>

<audio id="clickSound" preload="auto">
    <source src="audio/click.mp3" type="audio/mpeg">
</audio>

<script>

    let deviceId = localStorage.getItem("deviceId") || generateDeviceId(); // 获取生成的设备Id
//    let websocket = new WebSocket(`ws://118.31.102.119:4396/room?deviceId=${deviceId}`);
    let websocket = new WebSocket(`ws://localhost:4396/room?deviceId=${deviceId}`);

    // 添加显示房间已满提示的函数
    function showRoomFullTip() {
        const tip = document.getElementById('roomFullTip');
        tip.classList.add('show');
        
        // 1.5秒后隐藏提示
        setTimeout(() => {
            tip.classList.remove('show');
            // 恢复按钮和加载提示的状态
            document.getElementById("loadingMessage").style.display = "none";
            document.getElementById("joinBtn").disabled = false;
        }, 1500);
    }

    websocket.onmessage = function(event) {
        let data = JSON.parse(event.data);
        console.log('room.html - onmessage: ', data);

        // 检查是否是房间已满的消息
        if (data.type === 'room_full') {
            showRoomFullTip();
            return;
        }

        let playerData = {};  // 用于存储玩家信息
        let queryString;

        if (data.length === 1) {  // 蓝色方：只有一个玩家的数据
            let user = data[0]; // 获取蓝色方玩家数据
            playerData = {
                msgCode: user.msgCode,           // 消息码 (50)
                blueNickName: user.nickName,     // 蓝色方昵称
                blueWinRate: user.winRate,      // 蓝色方胜率
            };
        } else if (data.length === 2) {  // 红色方：两个玩家的数据
            let blueUser = data[0];  // 蓝色方玩家数据
            let redUser = data[1];   // 红色方玩家数据

            playerData = {
                msgCode: redUser.msgCode,  // 消息码 (60)
                blueNickName: blueUser.nickName, // 蓝色方昵称
                blueWinRate: blueUser.winRate,  // 蓝色方胜率
                redNickName: redUser.nickName,   // 红色方昵称
                redWinRate: redUser.winRate    // 红色方胜率
            };
        } else {
                console.error('Unexpected number of users: ' + data.length);
                return; // 如果不是 1 或 2，直接返回，避免错误
        }

            // 将 playerData 转换为查询字符串
            queryString = objectToQueryString(playerData);

            // 构建跳转的 URL
            let url = `xcards.html?${queryString}`;
            console.log('room.html - 跳转 url : ', url);

            // 跳转到游戏页面
            window.location.href = url;
    };

    // 将对象转为 URL 查询字符串的函数
    function objectToQueryString(obj) {
        const params = new URLSearchParams();
        for (const [key, value] of Object.entries(obj)) {
            params.append(key, value);
        }
        return params.toString();
    }

    websocket.onopen = function() {
            console.log('WebSocket connection opened - room');
        };
    websocket.onclose = function() {
        console.log('WebSocket connection closed - room');
        websocket = null;
    };
    websocket.onerror = function(error) {
        console.error('WebSocket error:', error);
        // 隐藏加载提示并恢复按钮状态
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("joinBtn").disabled = false;
    };

    document.getElementById("joinBtn").addEventListener("click", function() {
        joinRoom();
    });
    // 回车加入游戏
    document.getElementById("roomCodeInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            joinRoom();
        }
    });

     // 加入游戏函数
    function joinRoom() {
        let roomCode = document.getElementById("roomCodeInput").value.trim();
        if (!roomCode) {
            alert("请输入房间号！");
            return;
        }

        // 播放点击音效
        playClickSound();

        // 显示加载提示
        document.getElementById("loadingMessage").style.display = "block";
        document.getElementById("joinBtn").disabled = true;

        // 构造交互对象
        let playerData = {
            deviceId: deviceId,
            roomCode: roomCode,
            userCode: '', // 这里可以替换为用户的实际ID，如邮箱、微信openid等
            nickName: getNickname(), // 动态获取昵称
        };

        // 与后端WebSocket交互
        websocket.send(JSON.stringify(playerData)); // 发送到后端
    }

    // 玩家输入昵称
    function getNickname() {
        let nickname = localStorage.getItem("nickname");
        if (!nickname) {
            nickname = prompt("请输入您的���称：");
            if (nickname) {
                localStorage.setItem("nickname", nickname);
            } else {
                nickname = "匿名玩家"; // 默认昵称
            }
        }
        return nickname;
    }

    // 添加播放点击音效的函数
    function playClickSound() {
        const sound = document.getElementById('clickSound');
        sound.volume = 0.5;  // 设置音量为50%
        sound.currentTime = 0;  // 重置音频
        sound.play().catch(e => console.log('播放音效失败:', e));
    }

    window.onbeforeunload = function () {
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.close();
        }
    };

</script>
</body>
</html>
